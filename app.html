<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flux AI Pro - å°ˆæ¥­ AI åœ–åƒç”Ÿæˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            border: 'hsl(240 3.7% 15.9%)',
            input: 'hsl(240 3.7% 15.9%)',
            ring: 'hsl(142.1 76.2% 36.3%)',
            background: 'hsl(240 10% 3.9%)',
            foreground: 'hsl(0 0% 98%)',
            primary: {
              DEFAULT: 'hsl(142.1 76.2% 36.3%)',
              foreground: 'hsl(355.7 100% 97.3%)',
            },
            secondary: {
              DEFAULT: 'hsl(240 3.7% 15.9%)',
              foreground: 'hsl(0 0% 98%)',
            },
            muted: {
              DEFAULT: 'hsl(240 3.7% 15.9%)',
              foreground: 'hsl(240 5% 64.9%)',
            },
            accent: {
              DEFAULT: 'hsl(240 3.7% 15.9%)',
              foreground: 'hsl(0 0% 98%)',
            },
          },
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: hsl(240 3.7% 15.9%); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: hsl(240 5% 26%); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(240 5% 34%); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .glass-card { background: rgba(26, 26, 26, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
  </style>
</head>
<body class="bg-background text-foreground min-h-screen">
  <div class="container mx-auto p-6 max-w-7xl">
    <!-- Header -->
    <header class="mb-8 animate-slide-in">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-4xl font-bold text-primary flex items-center gap-3">
            ğŸ¨ Flux AI Pro
            <span class="text-sm bg-primary text-primary-foreground px-3 py-1 rounded-full">v9.3</span>
            <span class="text-xs bg-pink-600 text-white px-2 py-1 rounded-full">Seed æ§åˆ¶</span>
          </h1>
          <p class="text-muted-foreground mt-2 text-sm">
            ä¸­æ–‡æ”¯æŒ Â· åœ–ç”Ÿåœ– Â· å¤šåœ–èåˆ Â· 4Kè¶…æ¸… Â· 39ç¨®é¢¨æ ¼ Â· Seedæ§åˆ¶
          </p>
        </div>
        <button id="historyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all relative">
          ğŸ“œ æ­·å²
          <span id="historyBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </button>
      </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- å·¦å´:ç”Ÿæˆè¨­ç½® -->
      <div class="glass-card rounded-xl p-6 animate-slide-in" style="animation-delay: 0.1s">
        <h3 class="text-xl font-semibold text-primary mb-4">ğŸ“ ç”Ÿæˆè¨­ç½®</h3>
        
        <!-- æç¤ºè© -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">
            æç¤ºè© <span class="text-green-500 text-xs">âœ“ æ”¯æŒä¸­æ–‡</span>
          </label>
          <textarea id="prompt" rows="3" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„åœ–ç‰‡..."></textarea>
        </div>

        <!-- è² é¢æç¤ºè© -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">è² é¢æç¤ºè©</label>
          <textarea id="negativePrompt" rows="2" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" placeholder="low quality, blurry..."></textarea>
        </div>

        <!-- åƒè€ƒåœ–ç‰‡ -->
        <div class="mb-4 p-4 border-2 border-dashed border-pink-600 rounded-lg bg-pink-600/5">
          <label class="block text-sm font-medium mb-2 text-pink-400">ğŸ–¼ï¸ åƒè€ƒåœ– (åœ–ç”Ÿåœ–/å¤šåœ–èåˆ)</label>
          <div id="uploadArea" class="border-2 border-dashed border-pink-500/50 rounded-lg p-6 text-center cursor-pointer hover:border-pink-500 hover:bg-pink-600/10 transition-all">
            <div class="text-4xl mb-2">ğŸ“¤</div>
            <div class="text-pink-400 font-medium mb-1">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³åœ–ç‰‡</div>
            <div class="text-xs text-muted-foreground">æ”¯æŒ JPG, PNG, WebP</div>
          </div>
          <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
          <input type="text" id="refImageUrl" placeholder="æˆ–è¼¸å…¥åœ–ç‰‡ URL" class="w-full mt-3 px-4 py-2 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring text-sm">
          <div id="refImageList" class="flex gap-2 flex-wrap mt-3"></div>
          <small id="refImageLimit" class="text-xs text-muted-foreground block mt-2">kontext: æœ€å¤š1å¼µ | nanobanana: æœ€å¤š4å¼µ</small>
        </div>

        <!-- æ¨¡å‹é¸æ“‡ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">AI æ¨¡å‹</label>
          <select id="model" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
            <optgroup label="âš¡ Flux ç³»åˆ—">
              <option value="flux">Flux (å‡è¡¡)</option>
              <option value="flux-realism">Flux Realism (è¶…å¯«å¯¦)</option>
              <option value="flux-anime">Flux Anime (å‹•æ¼«)</option>
              <option value="flux-pro">Flux Pro (å°ˆæ¥­ç‰ˆ)</option>
              <option value="turbo">Turbo (æ¥µé€Ÿ)</option>
            </optgroup>
            <optgroup label="ğŸ¨ åœ–åƒç·¨è¼¯">
              <option value="flux-kontext">Kontext ğŸ¨ (1å¼µåƒè€ƒåœ–)</option>
              <option value="flux-kontext-pro">Kontext Pro ğŸ’ (1å¼µåƒè€ƒåœ–)</option>
            </optgroup>
            <optgroup label="ğŸŒ Nano Banana">
              <option value="nanobanana">Nano Banana ğŸŒ (4å¼µåƒè€ƒåœ–)</option>
              <option value="nanobanana-pro">Nano Banana Pro ğŸŒğŸ’ (4K+4å¼µ)</option>
            </optgroup>
          </select>
        </div>

        <!-- é¢¨æ ¼é¸æ“‡ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">è—è¡“é¢¨æ ¼</label>
          <select id="style" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
            <option value="none">ç„¡</option>
            <option value="anime">å‹•æ¼«é¢¨æ ¼ âœ¨</option>
            <option value="photorealistic">å¯«å¯¦ç…§ç‰‡ ğŸ“·</option>
            <option value="oil-painting">æ²¹ç•« ğŸ¨</option>
            <option value="watercolor">æ°´å½©ç•« ğŸ’§</option>
          </select>
        </div>
      </div>

      <!-- å³å´:åœ–åƒåƒæ•¸ -->
      <div class="glass-card rounded-xl p-6 animate-slide-in" style="animation-delay: 0.2s">
        <h3 class="text-xl font-semibold text-primary mb-4">ğŸ¨ åœ–åƒåƒæ•¸</h3>
        
        <!-- å°ºå¯¸é è¨­ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">å°ºå¯¸é è¨­</label>
          <select id="sizePreset" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
            <option value="square-1k" selected>æ–¹å½¢ 1K (1024x1024)</option>
            <option value="square-2k">æ–¹å½¢ 2K (2048x2048)</option>
            <option value="portrait-9-16-hd">è±å± 9:16 HD (1080x1920)</option>
            <option value="landscape-16-9-hd">æ©«å± 16:9 HD (1920x1080)</option>
            <option value="square-4k">æ–¹å½¢ 4K (4096x4096) ğŸŒ</option>
          </select>
        </div>

        <!-- å¯¬åº¦ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">å¯¬åº¦: <span id="widthValue" class="text-primary">1024</span>px</label>
          <input type="range" id="width" min="256" max="4096" step="64" value="1024" class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer">
        </div>

        <!-- é«˜åº¦ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">é«˜åº¦: <span id="heightValue" class="text-primary">1024</span>px</label>
          <input type="range" id="height" min="256" max="4096" step="64" value="1024" class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer">
        </div>

        <!-- ç”Ÿæˆæ•¸é‡ -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">ç”Ÿæˆæ•¸é‡</label>
          <div class="flex items-center gap-4">
            <input type="range" id="numImages" min="1" max="4" step="1" value="1" class="flex-1 h-2 bg-secondary rounded-lg appearance-none cursor-pointer">
            <span id="numImagesValue" class="text-primary font-bold text-lg min-w-[60px] text-center">1 å¼µ</span>
          </div>
        </div>

        <!-- Seed æ§åˆ¶ -->
        <div class="mb-4 p-4 bg-purple-600/10 border border-purple-600/30 rounded-lg">
          <label class="block text-sm font-medium mb-2 text-purple-400">ğŸ² éš¨æ©Ÿç¨®å­ (Seed)</label>
          <div class="flex gap-2 mb-2">
            <input type="number" id="seedInput" placeholder="ç•™ç©º=éš¨æ©Ÿ" min="0" max="999999" class="flex-1 px-4 py-2 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring font-mono">
            <button id="randomSeedBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all">ğŸ²</button>
          </div>
          <div class="flex gap-2">
            <button id="autoSeedBtn" class="flex-1 text-xs bg-purple-600/20 border border-purple-600 text-purple-400 px-3 py-1.5 rounded transition-all hover:bg-purple-600/30">è‡ªå‹•éš¨æ©Ÿ</button>
            <button id="copySeedBtn" class="flex-1 text-xs bg-green-600/20 border border-green-600 text-green-400 px-3 py-1.5 rounded transition-all hover:bg-green-600/30">ğŸ“‹ è¤‡è£½ä¸Šæ¬¡</button>
            <button id="clearSeedBtn" class="flex-1 text-xs bg-red-600/20 border border-red-600 text-red-400 px-3 py-1.5 rounded transition-all hover:bg-red-600/30">ğŸ—‘ï¸ æ¸…ç©º</button>
          </div>
          <div id="lastSeedInfo" class="hidden mt-3 p-2 bg-green-600/10 border border-green-600/30 rounded text-xs text-green-400"></div>
        </div>

        <!-- è³ªé‡æ¨¡å¼ -->
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">è³ªé‡æ¨¡å¼</label>
          <select id="qualityMode" class="w-full px-4 py-3 bg-secondary border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
            <option value="economy">âš¡ ç¶“æ¿Ÿ</option>
            <option value="standard" selected>â­ æ¨™æº–</option>
            <option value="ultra">ğŸ’ è¶…é«˜æ¸…</option>
            <option value="ultra_4k">ğŸŒ 4Kè¶…é«˜æ¸…</option>
          </select>
        </div>

        <!-- ç”ŸæˆæŒ‰éˆ• -->
        <button id="generateBtn" class="w-full bg-primary hover:bg-primary/90 text-primary-foreground font-bold py-4 rounded-lg transition-all shadow-lg hover:shadow-xl">
          ğŸš€ é–‹å§‹ç”Ÿæˆ
        </button>
      </div>
    </div>

    <!-- çµæœå±•ç¤º -->
    <div id="result" class="mt-8"></div>
  </div>

  <!-- æ­·å²è¨˜éŒ„ Modal -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black/80 z-50 overflow-auto">
    <div class="container mx-auto p-6 max-w-4xl mt-20">
      <div class="glass-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-primary">ğŸ“œ ç”Ÿæˆæ­·å²</h2>
          <button id="closeHistoryBtn" class="text-muted-foreground hover:text-foreground text-3xl font-bold">&times;</button>
        </div>
        <div class="flex gap-2 mb-4">
          <button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all">ğŸ—‘ï¸ æ¸…ç©ºæ­·å²</button>
        </div>
        <div id="historyList" class="custom-scrollbar max-h-[60vh] overflow-auto"></div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šæ•¸
    let generationHistory = [];
    let referenceImages = [];
    let lastUsedSeeds = [];
    const API_BASE = window.location.origin;

    // DOM å…ƒç´ 
    const $prompt = document.getElementById('prompt');
    const $negativePrompt = document.getElementById('negativePrompt');
    const $model = document.getElementById('model');
    const $style = document.getElementById('style');
    const $sizePreset = document.getElementById('sizePreset');
    const $width = document.getElementById('width');
    const $height = document.getElementById('height');
    const $widthValue = document.getElementById('widthValue');
    const $heightValue = document.getElementById('heightValue');
    const $numImages = document.getElementById('numImages');
    const $numImagesValue = document.getElementById('numImagesValue');
    const $seedInput = document.getElementById('seedInput');
    const $randomSeedBtn = document.getElementById('randomSeedBtn');
    const $autoSeedBtn = document.getElementById('autoSeedBtn');
    const $copySeedBtn = document.getElementById('copySeedBtn');
    const $clearSeedBtn = document.getElementById('clearSeedBtn');
    const $lastSeedInfo = document.getElementById('lastSeedInfo');
    const $qualityMode = document.getElementById('qualityMode');
    const $generateBtn = document.getElementById('generateBtn');
    const $result = document.getElementById('result');
    const $historyBtn = document.getElementById('historyBtn');
    const $historyModal = document.getElementById('historyModal');
    const $closeHistoryBtn = document.getElementById('closeHistoryBtn');
    const $clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const $historyList = document.getElementById('historyList');
    const $historyBadge = document.getElementById('historyBadge');
    const $uploadArea = document.getElementById('uploadArea');
    const $fileInput = document.getElementById('fileInput');
    const $refImageUrl = document.getElementById('refImageUrl');
    const $refImageList = document.getElementById('refImageList');
    const $refImageLimit = document.getElementById('refImageLimit');

    // å°ºå¯¸é è¨­
    const PRESETS = {
      'square-512': { width: 512, height: 512 },
      'square-1k': { width: 1024, height: 1024 },
      'square-1.5k': { width: 1536, height: 1536 },
      'square-2k': { width: 2048, height: 2048 },
      'square-4k': { width: 4096, height: 4096 },
      'portrait-9-16': { width: 768, height: 1344 },
      'portrait-9-16-hd': { width: 1080, height: 1920 },
      'landscape-16-9-hd': { width: 1920, height: 1080 },
      'landscape-16-9-2k': { width: 2560, height: 1440 },
    };

    // åˆå§‹åŒ–
    function init() {
      loadHistory();
      setupEventListeners();
      updateRefImageLimit();
    }

    function setupEventListeners() {
      $width.oninput = () => $widthValue.textContent = $width.value;
      $height.oninput = () => $heightValue.textContent = $height.value;
      $numImages.oninput = () => $numImagesValue.textContent = $numImages.value + ' å¼µ';
      $sizePreset.onchange = applySizePreset;
      $model.onchange = updateRefImageLimit;
      $randomSeedBtn.onclick = randomizeSeed;
      $autoSeedBtn.onclick = () => setSeed(-1);
      $copySeedBtn.onclick = copyLastSeed;
      $clearSeedBtn.onclick = () => setSeed('');
      $generateBtn.onclick = generate;
      $historyBtn.onclick = () => toggleHistory(true);
      $closeHistoryBtn.onclick = () => toggleHistory(false);
      $clearHistoryBtn.onclick = clearHistory;
      $uploadArea.onclick = () => $fileInput.click();
      $fileInput.onchange = handleFileUpload;
      $refImageUrl.onkeypress = (e) => { if (e.key === 'Enter') addUrlReference(); };
      setupDragAndDrop();
    }

    function applySizePreset() {
      const preset = PRESETS[$sizePreset.value];
      if (preset) {
        $width.value = preset.width;
        $height.value = preset.height;
        $widthValue.textContent = preset.width;
        $heightValue.textContent = preset.height;
      }
    }

    function randomizeSeed() {
      $seedInput.value = Math.floor(Math.random() * 1000000);
    }

    function setSeed(value) {
      $seedInput.value = value === -1 ? '' : value;
    }

    function copyLastSeed() {
      if (lastUsedSeeds.length === 0) {
        alert('å°šæœªç”Ÿæˆéåœ–ç‰‡');
        return;
      }
      setSeed(lastUsedSeeds[lastUsedSeeds.length - 1]);
    }

    function updateLastSeedInfo(seeds) {
      lastUsedSeeds = seeds;
      if (seeds && seeds.length > 0) {
        $lastSeedInfo.classList.remove('hidden');
        $lastSeedInfo.innerHTML = `âœ… ä¸Šæ¬¡ Seed: <strong>${seeds.join(', ')}</strong>`;
      } else {
        $lastSeedInfo.classList.add('hidden');
      }
    }

    function setupDragAndDrop() {
      $uploadArea.ondragover = (e) => { e.preventDefault(); $uploadArea.classList.add('border-pink-500', 'bg-pink-600/20'); };
      $uploadArea.ondragleave = () => $uploadArea.classList.remove('border-pink-500', 'bg-pink-600/20');
      $uploadArea.ondrop = async (e) => {
        e.preventDefault();
        $uploadArea.classList.remove('border-pink-500', 'bg-pink-600/20');
        await handleFiles(e.dataTransfer.files);
      };
    }

    async function handleFileUpload(e) {
      await handleFiles(e.target.files);
      e.target.value = '';
    }

    async function handleFiles(files) {
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) continue;
        if (file.size > 10 * 1024 * 1024) { alert(file.name + ' è¶…é 10MB'); continue; }
        await uploadImage(file);
      }
    }

    async function uploadImage(file) {
      try {
        const base64 = await fileToBase64(file);
        const url = await uploadToImageHost(base64, file.name);
        referenceImages.push(url);
        renderReferenceImages();
      } catch (error) {
        alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function uploadToImageHost(base64, filename) {
      try {
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: { 'Authorization': 'Client-ID 2afc620eb108124' },
          body: JSON.stringify({ image: base64.split(',')[1], type: 'base64', name: filename })
        });
        const data = await response.json();
        if (data.success) return data.data.link;
        throw new Error('Upload failed');
      } catch (error) {
        return base64; // Fallback to base64
      }
    }

    function addUrlReference() {
      const url = $refImageUrl.value.trim();
      if (url) {
        try {
          new URL(url);
          referenceImages.push(url);
          $refImageUrl.value = '';
          renderReferenceImages();
        } catch {
          alert('ç„¡æ•ˆçš„ URL');
        }
      }
    }

    function updateRefImageLimit() {
      const model = $model.value;
      const limits = {
        'flux-kontext': 1,
        'flux-kontext-pro': 1,
        'nanobanana': 4,
        'nanobanana-pro': 4
      };
      const maxRef = limits[model] || 0;
      $refImageLimit.textContent = maxRef > 0 ? `æœ€å¤šæ”¯æŒ ${maxRef} å¼µåƒè€ƒåœ– (å·²æ·»åŠ  ${referenceImages.length}/${maxRef})` : 'æ­¤æ¨¡å‹ä¸æ”¯æŒåƒè€ƒåœ–';
    }

    function renderReferenceImages() {
      $refImageList.innerHTML = referenceImages.map((url, i) => `
        <div class="relative w-20 h-20">
          <img src="${url}" class="w-full h-full object-cover rounded-lg border-2 border-pink-600">
          <button onclick="removeRefImage(${i})" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 text-sm font-bold">Ã—</button>
        </div>
      `).join('');
      updateRefImageLimit();
    }

    function removeRefImage(index) {
      referenceImages.splice(index, 1);
      renderReferenceImages();
    }

    async function generate() {
      const prompt = $prompt.value.trim();
      if (!prompt) { alert('è«‹è¼¸å…¥æç¤ºè©'); return; }

      const seedInput = $seedInput.value.trim();
      let seedValue = -1;
      if (seedInput !== '') {
        const parsed = parseInt(seedInput);
        if (!isNaN(parsed) && parsed >= 0 && parsed <= 999999) {
          seedValue = parsed;
        } else {
          alert('Seed å¿…é ˆæ˜¯ 0-999999 ä¹‹é–“çš„æ•´æ•¸');
          return;
        }
      }

      const params = {
        prompt,
        negative_prompt: $negativePrompt.value,
        model: $model.value,
        style: $style.value,
        width: parseInt($width.value),
        height: parseInt($height.value),
        quality_mode: $qualityMode.value,
        n: parseInt($numImages.value),
        seed: seedValue,
        reference_images: referenceImages,
        auto_optimize: true,
        auto_hd: true
      };

      $generateBtn.disabled = true;
      const startTime = Date.now();
      let timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        $generateBtn.textContent = `ç”Ÿæˆä¸­ â±ï¸ ${elapsed}s`;
      }, 100);

      try {
        const response = await fetch(`${API_BASE}/v1/images/generations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'ç”Ÿæˆå¤±æ•—');

        clearInterval(timerInterval);
        const duration = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        const seeds = data.data.map(item => item.seed);
        updateLastSeedInfo(seeds);

        $result.innerHTML = `
          <div class="glass-card rounded-xl p-4 mb-6 text-green-500">
            <strong>âœ… ç”ŸæˆæˆåŠŸ!</strong> <span class="text-muted-foreground">â±ï¸ ${duration} | å…± ${data.data.length} å¼µ</span>
          </div>
        `;

        data.data.forEach((item, index) => {
          const imgCard = document.createElement('div');
          imgCard.className = 'glass-card rounded-xl overflow-hidden mb-6 animate-slide-in';
          imgCard.innerHTML = `
            <div class="bg-primary/10 p-3 flex justify-between items-center">
              <span class="text-primary font-bold">åœ–ç‰‡ ${index + 1}/${data.data.length}</span>
              <span class="text-xs font-mono bg-black/30 px-2 py-1 rounded">Seed: ${item.seed}</span>
            </div>
            <img src="${item.url}" class="w-full cursor-pointer hover:opacity-90 transition-opacity">
            <div class="p-3 bg-green-600/10 border-t border-green-600/30 text-xs text-green-400">
              ${item.model} | ${item.width}x${item.height} | ${item.quality_mode}
              <button onclick="setSeed(${item.seed})" class="ml-2 bg-purple-600/30 border border-purple-600 px-2 py-1 rounded text-purple-400 hover:bg-purple-600/50">ğŸ² ä½¿ç”¨æ­¤ Seed</button>
            </div>
          `;
          imgCard.querySelector('img').onclick = () => window.open(item.url);
          $result.appendChild(imgCard);

          addToHistory({
            url: item.url,
            prompt: params.prompt,
            model: item.model,
            width: item.width,
            height: item.height,
            seed: item.seed,
            style: params.style,
            quality_mode: params.quality_mode,
            duration
          });
        });

        $generateBtn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆ';
        $generateBtn.disabled = false;
      } catch (error) {
        clearInterval(timerInterval);
        $result.innerHTML = `<div class="glass-card rounded-xl p-4 text-red-500"><strong>âŒ ç”Ÿæˆå¤±æ•—</strong><p class="mt-2">${error.message}</p></div>`;
        $generateBtn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆ';
        $generateBtn.disabled = false;
      }
    }

    function loadHistory() {
      try {
        const saved = localStorage.getItem('flux_ai_history');
        if (saved) {
          generationHistory = JSON.parse(saved);
          updateHistoryBadge();
        }
      } catch (e) {}
    }

    function saveHistory() {
      try {
        localStorage.setItem('flux_ai_history', JSON.stringify(generationHistory.slice(0, 100)));
      } catch (e) {}
    }

    function addToHistory(item) {
      generationHistory.unshift({ ...item, timestamp: new Date().toISOString() });
      if (generationHistory.length > 100) generationHistory = generationHistory.slice(0, 100);
      saveHistory();
      updateHistoryBadge();
    }

    function updateHistoryBadge() {
      if (generationHistory.length > 0) {
        $historyBadge.textContent = generationHistory.length;
        $historyBadge.classList.remove('hidden');
      } else {
        $historyBadge.classList.add('hidden');
      }
    }

    function toggleHistory(show) {
      $historyModal.classList.toggle('hidden', !show);
      if (show) renderHistory();
    }

    function renderHistory() {
      if (generationHistory.length === 0) {
        $historyList.innerHTML = '<p class="text-center text-muted-foreground">æš«ç„¡æ­·å²è¨˜éŒ„</p>';
        return;
      }
      $historyList.innerHTML = generationHistory.map((item, i) => `
        <div class="glass-card rounded-lg p-4 mb-3 hover:bg-primary/5 transition-all">
          <div class="flex gap-4">
            <img src="${item.url}" class="w-24 h-24 object-cover rounded-lg cursor-pointer" onclick="window.open('${item.url}')">
            <div class="flex-1">
              <p class="text-primary font-semibold">${item.prompt.substring(0, 50)}...</p>
              <p class="text-xs text-muted-foreground mt-1">${item.model} | ${item.width}x${item.height} | Seed: ${item.seed || 'N/A'}</p>
              <p class="text-xs text-muted-foreground">${new Date(item.timestamp).toLocaleString('zh-TW')}</p>
              <div class="flex gap-2 mt-2">
                <button onclick="regenFromHistory(${i})" class="text-xs bg-primary/20 border border-primary text-primary px-2 py-1 rounded hover:bg-primary/30">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                ${item.seed ? `<button onclick="setSeed(${item.seed}); toggleHistory(false)" class="text-xs bg-purple-600/20 border border-purple-600 text-purple-400 px-2 py-1 rounded hover:bg-purple-600/30">ğŸ² ä½¿ç”¨ Seed</button>` : ''}
                <button onclick="deleteHistory(${i})" class="text-xs bg-red-600/20 border border-red-600 text-red-400 px-2 py-1 rounded hover:bg-red-600/30">ğŸ—‘ï¸ åˆªé™¤</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function regenFromHistory(index) {
      const item = generationHistory[index];
      $prompt.value = item.prompt;
      $model.value = item.model;
      $width.value = item.width;
      $height.value = item.height;
      $widthValue.textContent = item.width;
      $heightValue.textContent = item.height;
      if (item.style) $style.value = item.style;
      if (item.quality_mode) $qualityMode.value = item.quality_mode;
      if (item.seed) $seedInput.value = item.seed;
      toggleHistory(false);
      alert('å·²è¼‰å…¥æ­·å²é…ç½®!');
    }

    function deleteHistory(index) {
      if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¨˜éŒ„?')) {
        generationHistory.splice(index, 1);
        saveHistory();
        updateHistoryBadge();
        renderHistory();
      }
    }

    function clearHistory() {
      if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ­·å²è¨˜éŒ„?')) {
        generationHistory = [];
        saveHistory();
        updateHistoryBadge();
        renderHistory();
      }
    }

    // åˆå§‹åŒ–æ‡‰ç”¨
    init();
  </script>
</body>
</html>